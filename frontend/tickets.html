<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Tickets - Plataforma SecretarÃ­a</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <header class="bg-blue-900 text-white p-4 text-center">
      <h1 class="text-2xl font-bold">
        Plataforma SecretarÃ­a - Escuela de Ciencias Exactas
      </h1>
      <p class="text-sm">Universidad Sergio Arboleda</p>
    </header>

    <nav class="flex justify-between items-center bg-blue-700 text-white p-2">
      <div class="space-x-4">
        <a href="foro.html" class="hover:underline">Foro</a>
        <a href="publicaciones.html" class="hover:underline">Publicaciones</a>
        <a href="tickets.html" class="underline font-semibold">Tickets</a>
      </div>
      <div class="flex items-center space-x-3">
        <span id="rol-usuario" class="text-white text-sm"></span>
        <button
          onclick="cerrarSesion()"
          class="bg-red-500 px-3 py-1 rounded hover:bg-red-600 transition-colors"
        >
          Cerrar sesiÃ³n
        </button>
      </div>
    </nav>

    <div class="foro-bg">
      <main class="p-6">
        <section id="tickets">
          <!-- Header dinÃ¡mico segÃºn el rol -->
          <div class="mb-6">
            <h2
              id="tickets-title"
              class="text-2xl font-bold text-gray-800 mb-2"
            >
              ğŸ« Sistema de Tickets
            </h2>
            <p id="tickets-description" class="text-gray-600">
              GestiÃ³n de solicitudes estudiantiles
            </p>
          </div>

          <!-- ğŸ“ PANEL PARA ESTUDIANTES - Crear tickets -->
          <section id="estudiante-panel" class="mb-8">
            <div
              class="bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-lg shadow-lg"
            >
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <span class="text-3xl mr-3">ğŸ“</span>
                  <div>
                    <h2 class="text-2xl font-bold">Panel de Estudiante</h2>
                    <p class="text-blue-100">
                      EnvÃ­a solicitudes a la secretarÃ­a acadÃ©mica
                    </p>
                  </div>
                </div>

                <div class="bg-white rounded-lg p-6 text-gray-800">
                  <h3 class="text-xl font-semibold mb-4">
                    âœ‰ï¸ Crear Nueva Solicitud
                  </h3>

                  <form id="form-ticket" class="space-y-4">
                    <!-- TÃ­tulo -->
                    <div>
                      <label
                        for="titulo"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        TÃ­tulo de la solicitud (opcional)
                      </label>
                      <input
                        id="titulo"
                        type="text"
                        placeholder="Ej: Solicitud de certificado acadÃ©mico"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <p class="mt-1 text-sm text-gray-500">
                        Si no especificas un tÃ­tulo, se crearÃ¡ como "Solicitud
                        general"
                      </p>
                    </div>

                    <!-- Campo Tema -->
                    <div>
                      <label
                        for="tema"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Tema de la solicitud <span class="text-red-500">*</span>
                      </label>
                      <select
                        id="tema"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      >
                        <option value="">Selecciona un tema...</option>
                        <option value="materia">ğŸ“š Materias y Horarios</option>
                        <option value="practicas">
                          ğŸ”¬ PrÃ¡cticas Profesionales
                        </option>
                        <option value="certificados">
                          ğŸ“„ Certificados y Documentos
                        </option>
                        <option value="matricula">ğŸ“ MatrÃ­cula y Pagos</option>
                        <option value="notas">ğŸ“Š Notas y Calificaciones</option>
                        <option value="tramites">
                          ğŸ“‹ TrÃ¡mites Administrativos
                        </option>
                        <option value="becas">ğŸ’° Becas y Ayudas</option>
                        <option value="otro">â“ Otro</option>
                      </select>
                    </div>

                    <!-- DescripciÃ³n -->
                    <div>
                      <label
                        for="mensaje"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        DescripciÃ³n detallada
                        <span class="text-red-500">*</span>
                      </label>
                      <textarea
                        id="mensaje"
                        placeholder="Describe tu solicitud con el mayor detalle posible..."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        rows="5"
                        required
                      ></textarea>
                      <p class="mt-1 text-sm text-gray-500">
                        Incluye toda la informaciÃ³n relevante para que puedan
                        ayudarte mejor
                      </p>
                    </div>

                    <button
                      type="submit"
                      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center"
                    >
                      <span class="mr-2">ğŸ“¤</span>
                      Enviar Solicitud
                    </button>

                    <div
                      id="form-mensaje"
                      class="text-center text-sm mt-4"
                    ></div>
                  </form>
                </div>
              </div>
            </div>
          </section>

          <!-- ğŸ“‹ PANEL PARA SECRETARIAS -->
          <section id="secretaria-panel" class="hidden mb-8">
            <div
              class="bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg shadow-lg"
            >
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <span class="text-3xl mr-3">ğŸ“‹</span>
                  <div>
                    <h2 class="text-2xl font-bold">Panel de SecretarÃ­a</h2>
                    <p class="text-purple-100">
                      GestiÃ³n de solicitudes estudiantiles
                    </p>
                  </div>
                </div>

                <div class="bg-white rounded-lg p-6 text-gray-800">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">
                      ğŸ“¬ Solicitudes Recibidas
                    </h3>
                    <div class="flex space-x-2">
                      <button
                        onclick="filtrarPorEstado('todos')"
                        class="px-3 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300"
                        id="btn-todos"
                      >
                        Todos
                      </button>
                      <button
                        onclick="filtrarPorEstado('abierto')"
                        class="px-3 py-1 bg-green-200 rounded text-sm hover:bg-green-300"
                        id="btn-abiertos"
                      >
                        Abiertos
                      </button>
                      <button
                        onclick="filtrarPorEstado('en_proceso')"
                        class="px-3 py-1 bg-yellow-200 rounded text-sm hover:bg-yellow-300"
                        id="btn-proceso"
                      >
                        En Proceso
                      </button>
                      <button
                        onclick="filtrarPorEstado('cerrado')"
                        class="px-3 py-1 bg-red-200 rounded text-sm hover:bg-red-300"
                        id="btn-cerrados"
                      >
                        Cerrados
                      </button>
                    </div>
                  </div>

                  <div class="text-sm text-gray-600 mb-4">
                    <p>
                      <strong>ğŸ’¡ Instrucciones:</strong> Haz clic en cualquier
                      ticket para ver detalles y responder.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- ğŸ‘‘ PANEL PARA ADMINS - âœ… MEJORADO CON FILTROS POR CATEGORÃA -->
          <section id="admin-tickets-panel" class="hidden mb-8">
            <div
              class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg shadow-lg"
            >
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <span class="text-3xl mr-3">ğŸ‘‘</span>
                  <div>
                    <h2 class="text-2xl font-bold">Panel de AdministraciÃ³n</h2>
                    <p class="text-purple-100">
                      Control total del sistema de tickets
                    </p>
                  </div>
                </div>

                <div class="bg-white rounded-lg p-6 text-gray-800">
                  <!-- âœ… CONTADORES GENERALES -->
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-green-600"
                        id="count-abiertos"
                      >
                        0
                      </div>
                      <div class="text-sm text-green-800">Abiertos</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-yellow-600"
                        id="count-proceso"
                      >
                        0
                      </div>
                      <div class="text-sm text-yellow-800">En Proceso</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-red-600"
                        id="count-cerrados"
                      >
                        0
                      </div>
                      <div class="text-sm text-red-800">Cerrados</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-blue-600"
                        id="count-total"
                      >
                        0
                      </div>
                      <div class="text-sm text-blue-800">Total</div>
                    </div>
                  </div>

                  <!-- âœ… NUEVO: FILTROS POR ESTADO -->
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">
                      ğŸ“Š Filtrar por Estado:
                    </h4>
                    <div class="flex flex-wrap gap-2">
                      <button
                        onclick="filtrarPorEstado('todos')"
                        class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
                        id="btn-admin-todos"
                      >
                        ğŸ“‹ Todos
                      </button>
                      <button
                        onclick="filtrarPorEstado('abierto')"
                        class="px-3 py-1 bg-green-200 text-green-800 rounded text-sm hover:bg-green-300"
                        id="btn-admin-abiertos"
                      >
                        ğŸŸ¢ Abiertos
                      </button>
                      <button
                        onclick="filtrarPorEstado('en_proceso')"
                        class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded text-sm hover:bg-yellow-300"
                        id="btn-admin-proceso"
                      >
                        ğŸŸ¡ En Proceso
                      </button>
                      <button
                        onclick="filtrarPorEstado('cerrado')"
                        class="px-3 py-1 bg-red-200 text-red-800 rounded text-sm hover:bg-red-300"
                        id="btn-admin-cerrados"
                      >
                        ğŸ”´ Cerrados
                      </button>
                    </div>
                  </div>

                  <!-- âœ… NUEVO: FILTROS POR CATEGORÃA/TEMA -->
                  <div class="mb-6 border-t pt-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">
                      ğŸ·ï¸ Filtrar por CategorÃ­a:
                    </h4>
                    <div
                      class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2"
                    >
                      <button
                        onclick="filtrarPorTema('todos')"
                        class="px-2 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600"
                        id="tema-todos"
                      >
                        ğŸ“‚ Todas
                      </button>
                      <button
                        onclick="filtrarPorTema('materia')"
                        class="px-2 py-1 bg-purple-200 text-purple-800 rounded text-xs hover:bg-purple-300"
                        id="tema-materia"
                      >
                        ğŸ“š Materias
                        <span class="block text-xs" id="count-materia">0</span>
                      </button>
                      <button
                        onclick="filtrarPorTema('practicas')"
                        class="px-2 py-1 bg-indigo-200 text-indigo-800 rounded text-xs hover:bg-indigo-300"
                        id="tema-practicas"
                      >
                        ğŸ”¬ PrÃ¡cticas
                        <span class="block text-xs" id="count-practicas"
                          >0</span
                        >
                      </button>
                      <button
                        onclick="filtrarPorTema('certificados')"
                        class="px-2 py-1 bg-blue-200 text-blue-800 rounded text-xs hover:bg-blue-300"
                        id="tema-certificados"
                      >
                        ğŸ“„ Certificados
                        <span class="block text-xs" id="count-certificados"
                          >0</span
                        >
                      </button>
                      <button
                        onclick="filtrarPorTema('matricula')"
                        class="px-2 py-1 bg-green-200 text-green-800 rounded text-xs hover:bg-green-300"
                        id="tema-matricula"
                      >
                        ğŸ“ MatrÃ­cula
                        <span class="block text-xs" id="count-matricula"
                          >0</span
                        >
                      </button>
                      <button
                        onclick="filtrarPorTema('notas')"
                        class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded text-xs hover:bg-yellow-300"
                        id="tema-notas"
                      >
                        ğŸ“Š Notas
                        <span class="block text-xs" id="count-notas">0</span>
                      </button>
                      <button
                        onclick="filtrarPorTema('tramites')"
                        class="px-2 py-1 bg-orange-200 text-orange-800 rounded text-xs hover:bg-orange-300"
                        id="tema-tramites"
                      >
                        ğŸ“‹ TrÃ¡mites
                        <span class="block text-xs" id="count-tramites">0</span>
                      </button>
                      <button
                        onclick="filtrarPorTema('becas')"
                        class="px-2 py-1 bg-pink-200 text-pink-800 rounded text-xs hover:bg-pink-300"
                        id="tema-becas"
                      >
                        ğŸ’° Becas
                        <span class="block text-xs" id="count-becas">0</span>
                      </button>
                      <button
                        onclick="filtrarPorTema('otro')"
                        class="px-2 py-1 bg-gray-200 text-gray-800 rounded text-xs hover:bg-gray-300"
                        id="tema-otro"
                      >
                        â“ Otro
                        <span class="block text-xs" id="count-otro">0</span>
                      </button>
                    </div>
                  </div>

                  <!-- âœ… INDICADOR DE FILTRO ACTIVO -->
                  <div
                    id="filtro-activo"
                    class="mb-4 p-2 bg-blue-50 rounded text-sm text-blue-800 hidden"
                  >
                    <span id="filtro-texto">Mostrando todos los tickets</span>
                    <button
                      onclick="limpiarFiltros()"
                      class="ml-2 text-blue-600 hover:text-blue-800 underline"
                    >
                      âœ• Limpiar filtros
                    </button>
                  </div>

                  <div class="text-sm text-gray-600 mb-4">
                    <p>
                      <strong>ğŸ’¡ Instrucciones:</strong> Usa los filtros de
                      arriba para organizar tickets. Haz clic en cualquier
                      ticket para responder.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- InformaciÃ³n del sistema -->
          <div
            class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500"
          >
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="flex items-center">
                <span
                  class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"
                ></span>
                <span><strong>ABIERTO:</strong> Ticket reciÃ©n creado</span>
              </div>
              <div class="flex items-center">
                <span
                  class="inline-block w-3 h-3 bg-yellow-500 rounded-full mr-2"
                ></span>
                <span><strong>EN PROCESO:</strong> Siendo atendido</span>
              </div>
              <div class="flex items-center">
                <span
                  class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"
                ></span>
                <span><strong>CERRADO:</strong> Resuelto o finalizado</span>
              </div>
            </div>
          </div>

          <!-- Lista de tickets -->
          <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
              <h3
                id="tickets-list-title"
                class="text-xl font-semibold text-gray-800"
              >
                ğŸ“‹ Tickets
              </h3>
              <button
                onclick="cargarTickets()"
                class="text-blue-600 hover:text-blue-800 text-sm"
                title="Actualizar lista"
              >
                ğŸ”„ Actualizar
              </button>
            </div>

            <div id="loading-tickets" class="text-center py-8">
              <div
                class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
              ></div>
              <p class="mt-2 text-gray-600">Cargando tickets...</p>
            </div>

            <div id="ticket-lista" class="space-y-4">
              <!-- Los tickets se cargan aquÃ­ dinÃ¡micamente -->
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal para ver/responder ticket -->
    <div
      id="ticket-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              ğŸ“„ Detalles del Ticket
            </h3>
            <button
              onclick="cerrarModal()"
              class="text-gray-500 hover:text-gray-700 text-2xl"
            >
              Ã—
            </button>
          </div>

          <div id="ticket-content">
            <!-- Contenido del ticket se genera aquÃ­ -->
          </div>

          <!-- SecciÃ³n para respuestas existentes -->
          <div id="respuestas-existentes" class="mt-6 border-t pt-4">
            <h4 class="font-semibold mb-3">ğŸ’¬ Respuestas</h4>
            <div id="lista-respuestas">
              <!-- Las respuestas se cargan aquÃ­ -->
            </div>
          </div>

          <!-- SecciÃ³n para responder (solo secretarias y admins) -->
          <div id="respuesta-section" class="hidden mt-6 border-t pt-4">
            <h4 class="font-semibold mb-3">ğŸ’¬ Responder al Ticket</h4>
            <form id="form-respuesta">
              <textarea
                id="respuesta-texto"
                placeholder="Escribe tu respuesta..."
                class="w-full p-3 border border-gray-300 rounded-lg mb-3"
                rows="4"
                required
              ></textarea>

              <div class="flex justify-between items-center">
                <select
                  id="nuevo-estado"
                  class="border border-gray-300 rounded px-3 py-2"
                >
                  <option value="en_proceso">En Proceso</option>
                  <option value="cerrado">Cerrado/Resuelto</option>
                </select>

                <button
                  type="submit"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
                >
                  ğŸ“¤ Enviar Respuesta
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="js/api-client.js"></script>
    <script src="js/simple-role.js"></script>

    <script>
      // âœ… VARIABLES GLOBALES MEJORADAS
      let currentEstadoFilter = "todos";
      let currentTemaFilter = "todos";
      let allTickets = [];
      let currentTicketId = null;

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("ğŸš€ Iniciando sistema de tickets...");

        if (!apiClient.sessionId) {
          console.log("âŒ No hay sesiÃ³n, redirigiendo...");
          window.location.href = "index.html";
          return;
        }

        await verificarRolYMostrarPanel();
        configurarEventListeners();
        await cargarTickets();
      });

      async function verificarRolYMostrarPanel() {
        try {
          const user = apiClient.getCurrentUser();
          console.log("ğŸ‘¤ Usuario actual:", user);

          if (!user) {
            try {
              const apiUser = await apiClient.getUserInfo();
              verificarYMostrarPorRol(apiUser);
            } catch (error) {
              console.error("âŒ Error obteniendo usuario de API:", error);
              mostrarPanelEstudiante();
            }
          } else {
            verificarYMostrarPorRol(user);
          }
        } catch (error) {
          console.error("âŒ Error verificando rol:", error);
          mostrarPanelEstudiante();
        }
      }

      function verificarYMostrarPorRol(user) {
        console.log("ğŸ” Verificando rol:", user.rol);

        const rolesEstudiante = ["estudiante", "usuario", "student"];
        const rolesAdmin = ["admin", "administrator"];
        const rolesSecretaria = ["secretaria", "secretary"];

        if (rolesEstudiante.includes(user.rol)) {
          console.log("âœ… Usuario es estudiante, mostrando panel...");
          mostrarPanelEstudiante();
        } else if (rolesSecretaria.includes(user.rol)) {
          console.log("âœ… Usuario es secretaria, mostrando panel...");
          mostrarPanelSecretaria();
        } else if (rolesAdmin.includes(user.rol)) {
          console.log("âœ… Usuario es admin, mostrando panel...");
          mostrarPanelAdmin();
        } else {
          console.log(
            `âš ï¸ Rol no reconocido: "${user.rol}", mostrando panel de estudiante por defecto`
          );
          mostrarPanelEstudiante();
        }
      }

      function mostrarPanelEstudiante() {
        console.log("ğŸ“ Mostrando panel de estudiante...");

        document.getElementById("estudiante-panel")?.classList.remove("hidden");
        document.getElementById("secretaria-panel")?.classList.add("hidden");
        document.getElementById("admin-tickets-panel")?.classList.add("hidden");

        document.getElementById("tickets-title").textContent =
          "ğŸ« Mis Solicitudes";
        document.getElementById("tickets-description").textContent =
          "EnvÃ­a solicitudes a la secretarÃ­a acadÃ©mica";
        document.getElementById("tickets-list-title").textContent =
          "ğŸ“‹ Mis Tickets";
      }

      function mostrarPanelSecretaria() {
        console.log("ğŸ“‹ Mostrando panel de secretaria...");
        document.getElementById("secretaria-panel")?.classList.remove("hidden");
        document.getElementById("estudiante-panel")?.classList.add("hidden");
        document.getElementById("admin-tickets-panel")?.classList.add("hidden");

        document.getElementById("tickets-title").textContent =
          "ğŸ“¬ Solicitudes Estudiantiles";
        document.getElementById("tickets-description").textContent =
          "Gestiona las solicitudes de los estudiantes";
        document.getElementById("tickets-list-title").textContent =
          "ğŸ“‹ Tickets Recibidos";
      }

      function mostrarPanelAdmin() {
        console.log("ğŸ‘‘ Mostrando panel de admin...");
        document
          .getElementById("admin-tickets-panel")
          ?.classList.remove("hidden");
        document.getElementById("estudiante-panel")?.classList.add("hidden");
        document.getElementById("secretaria-panel")?.classList.add("hidden");

        document.getElementById("tickets-title").textContent =
          "ğŸ‘‘ AdministraciÃ³n de Tickets";
        document.getElementById("tickets-description").textContent =
          "Control total del sistema de solicitudes";
        document.getElementById("tickets-list-title").textContent =
          "ğŸ“‹ Todos los Tickets";
      }

      function configurarEventListeners() {
        const formTicket = document.getElementById("form-ticket");
        if (formTicket) {
          formTicket.addEventListener("submit", async (e) => {
            e.preventDefault();
            await crearTicket();
          });
        }

        const formRespuesta = document.getElementById("form-respuesta");
        if (formRespuesta) {
          formRespuesta.addEventListener("submit", async (e) => {
            e.preventDefault();
            await responderTicket();
          });
        }
      }

      async function crearTicket() {
        const titulo = document.getElementById("titulo").value.trim() || null;
        const tema = document.getElementById("tema").value.trim();
        const mensaje = document.getElementById("mensaje").value.trim();

        if (!tema) {
          mostrarMensajeForm("âŒ Debes seleccionar un tema", "error");
          return;
        }

        if (!mensaje) {
          mostrarMensajeForm("âŒ El mensaje es requerido", "error");
          return;
        }

        try {
          mostrarMensajeForm("ğŸ”„ Enviando solicitud...", "info");

          const ticketData = {
            titulo: titulo || `Solicitud sobre ${getTemaNombre(tema)}`,
            mensaje: `[${getTemaNombre(tema)}] ${mensaje}`,
            tema: tema,
          };

          await apiClient.createTicket(ticketData);

          mostrarMensajeForm("âœ… Solicitud enviada exitosamente", "success");

          document.getElementById("titulo").value = "";
          document.getElementById("tema").value = "";
          document.getElementById("mensaje").value = "";

          await cargarTickets();
        } catch (error) {
          console.error("âŒ Error creando ticket:", error);
          mostrarMensajeForm(`âŒ Error: ${error.message}`, "error");
        }
      }

      function getTemaNombre(valor) {
        const temas = {
          materia: "Materias y Horarios",
          practicas: "PrÃ¡cticas Profesionales",
          certificados: "Certificados y Documentos",
          matricula: "MatrÃ­cula y Pagos",
          notas: "Notas y Calificaciones",
          tramites: "TrÃ¡mites Administrativos",
          becas: "Becas y Ayudas",
          otro: "Otro",
        };
        return temas[valor] || valor;
      }

      function getTemaIcon(valor) {
        const iconos = {
          materia: "ğŸ“š",
          practicas: "ğŸ”¬",
          certificados: "ğŸ“„",
          matricula: "ğŸ“",
          notas: "ğŸ“Š",
          tramites: "ğŸ“‹",
          becas: "ğŸ’°",
          otro: "â“",
        };
        return iconos[valor] || "ğŸ“";
      }

      async function cargarTickets() {
        const loadingElement = document.getElementById("loading-tickets");
        const listaElement = document.getElementById("ticket-lista");

        try {
          if (loadingElement) loadingElement.style.display = "block";
          if (listaElement) listaElement.innerHTML = "";

          const tickets = await apiClient.getTickets();
          allTickets = tickets;
          console.log(`âœ… ${tickets.length} tickets cargados`);

          if (loadingElement) loadingElement.style.display = "none";

          // âœ… ACTUALIZAR CONTADORES
          actualizarContadores(tickets);
          actualizarContadoresPorTema(tickets);

          // âœ… APLICAR FILTROS ACTIVOS
          aplicarFiltros();
        } catch (error) {
          console.error("âŒ Error cargando tickets:", error);
          if (loadingElement) loadingElement.style.display = "none";
          if (listaElement) {
            listaElement.innerHTML = `<div class="text-center text-red-500 py-8">Error: ${error.message}</div>`;
          }
        }
      }

      // âœ… NUEVA FUNCIÃ“N: APLICAR FILTROS COMBINADOS
      function aplicarFiltros() {
        let ticketsFiltrados = allTickets;

        // Filtrar por estado
        if (currentEstadoFilter !== "todos") {
          ticketsFiltrados = ticketsFiltrados.filter(
            (ticket) => ticket.estado === currentEstadoFilter
          );
        }

        // Filtrar por tema
        if (currentTemaFilter !== "todos") {
          ticketsFiltrados = ticketsFiltrados.filter(
            (ticket) => ticket.tema === currentTemaFilter
          );
        }

        mostrarTickets(ticketsFiltrados);
        actualizarIndicadorFiltro();
      }

      // âœ… NUEVA FUNCIÃ“N: FILTRAR POR ESTADO
      function filtrarPorEstado(estado) {
        currentEstadoFilter = estado;

        // Actualizar botones de estado
        document.querySelectorAll('[id^="btn-"]').forEach((btn) => {
          btn.classList.remove("bg-blue-500", "text-white");
        });

        const btnId =
          estado === "todos" ? "btn-admin-todos" : `btn-admin-${estado}`;
        document
          .getElementById(btnId)
          ?.classList.add("bg-blue-500", "text-white");

        aplicarFiltros();
      }

      // âœ… NUEVA FUNCIÃ“N: FILTRAR POR TEMA
      function filtrarPorTema(tema) {
        currentTemaFilter = tema;

        // Actualizar botones de tema
        document.querySelectorAll('[id^="tema-"]').forEach((btn) => {
          btn.classList.remove("ring-2", "ring-blue-500");
        });

        document
          .getElementById(`tema-${tema}`)
          ?.classList.add("ring-2", "ring-blue-500");

        aplicarFiltros();
      }

      // âœ… NUEVA FUNCIÃ“N: LIMPIAR FILTROS
      function limpiarFiltros() {
        currentEstadoFilter = "todos";
        currentTemaFilter = "todos";

        // Resetear botones
        document.querySelectorAll('[id^="btn-"]').forEach((btn) => {
          btn.classList.remove("bg-blue-500", "text-white");
        });
        document
          .getElementById("btn-admin-todos")
          ?.classList.add("bg-blue-500", "text-white");

        document.querySelectorAll('[id^="tema-"]').forEach((btn) => {
          btn.classList.remove("ring-2", "ring-blue-500");
        });
        document
          .getElementById("tema-todos")
          ?.classList.add("ring-2", "ring-blue-500");

        aplicarFiltros();
      }

      // âœ… NUEVA FUNCIÃ“N: ACTUALIZAR INDICADOR DE FILTRO
      function actualizarIndicadorFiltro() {
        const indicador = document.getElementById("filtro-activo");
        const texto = document.getElementById("filtro-texto");

        if (currentEstadoFilter === "todos" && currentTemaFilter === "todos") {
          indicador.classList.add("hidden");
          return;
        }

        let descripcion = "Mostrando tickets";

        if (currentTemaFilter !== "todos") {
          descripcion += ` de categorÃ­a "${getTemaNombre(currentTemaFilter)}"`;
        }

        if (currentEstadoFilter !== "todos") {
          descripcion += ` con estado "${currentEstadoFilter.replace(
            "_",
            " "
          )}"`;
        }

        texto.textContent = descripcion;
        indicador.classList.remove("hidden");
      }

      function mostrarTickets(tickets) {
        const listaElement = document.getElementById("ticket-lista");

        if (tickets.length === 0) {
          listaElement.innerHTML =
            '<div class="text-center text-gray-500 py-8">No hay tickets que coincidan con los filtros</div>';
          return;
        }

        listaElement.innerHTML = "";

        tickets.forEach((ticket) => {
          const item = document.createElement("div");
          item.className =
            "bg-white p-4 rounded border-l-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer";

          const estadoColors = {
            abierto: "border-green-500 bg-green-50",
            en_proceso: "border-yellow-500 bg-yellow-50",
            cerrado: "border-red-500 bg-red-50",
          };

          item.className +=
            " " + (estadoColors[ticket.estado] || "border-gray-500");

          const fecha = new Date(ticket.fecha_creacion).toLocaleDateString(
            "es-ES"
          );

          // âœ… MOSTRAR TEMA CON ICONO
          const temaHTML = ticket.tema
            ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">
                ${getTemaIcon(ticket.tema)} ${getTemaNombre(ticket.tema)}
               </span>`
            : "";

          item.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-semibold text-lg">${
                ticket.titulo || "Solicitud General"
              }</h4>
              <span class="text-xs px-2 py-1 rounded-full bg-gray-200">
                ${ticket.estado.toUpperCase().replace("_", " ")}
              </span>
            </div>
            <div class="mb-2">
              ${temaHTML}
            </div>
            <p class="text-gray-700 mb-2 line-clamp-2">${ticket.mensaje}</p>
            <div class="text-sm text-gray-500">
              <span>ğŸ‘¤ ${ticket.usuario_nombre || ticket.nombre}</span>
              <span class="float-right">ğŸ“… ${fecha}</span>
            </div>
          `;

          item.onclick = () => abrirModalTicket(ticket);
          listaElement.appendChild(item);
        });
      }

      function actualizarContadores(tickets) {
        const user = apiClient.getCurrentUser();
        if (user?.rol !== "admin") return;

        const contadores = {
          abierto: tickets.filter((t) => t.estado === "abierto").length,
          en_proceso: tickets.filter((t) => t.estado === "en_proceso").length,
          cerrado: tickets.filter((t) => t.estado === "cerrado").length,
          total: tickets.length,
        };

        document.getElementById("count-abiertos").textContent =
          contadores.abierto;
        document.getElementById("count-proceso").textContent =
          contadores.en_proceso;
        document.getElementById("count-cerrados").textContent =
          contadores.cerrado;
        document.getElementById("count-total").textContent = contadores.total;
      }

      // âœ… NUEVA FUNCIÃ“N: ACTUALIZAR CONTADORES POR TEMA
      function actualizarContadoresPorTema(tickets) {
        const user = apiClient.getCurrentUser();
        if (user?.rol !== "admin") return;

        const temas = [
          "materia",
          "practicas",
          "certificados",
          "matricula",
          "notas",
          "tramites",
          "becas",
          "otro",
        ];

        temas.forEach((tema) => {
          const count = tickets.filter((ticket) => ticket.tema === tema).length;
          const elemento = document.getElementById(`count-${tema}`);
          if (elemento) {
            elemento.textContent = count;
          }
        });
      }

      async function abrirModalTicket(ticket) {
        currentTicketId = ticket.id;
        const modal = document.getElementById("ticket-modal");
        const content = document.getElementById("ticket-content");
        const respuestaSection = document.getElementById("respuesta-section");

        const fecha = new Date(ticket.fecha_creacion).toLocaleDateString(
          "es-ES"
        );
        const temaHTML = ticket.tema
          ? `<span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
              ${getTemaIcon(ticket.tema)} ${getTemaNombre(ticket.tema)}
             </span>`
          : "";

        content.innerHTML = `
          <div class="border-l-4 border-blue-500 bg-blue-50 p-4 mb-4">
            <h4 class="font-bold text-lg mb-2">${
              ticket.titulo || "Solicitud General"
            }</h4>
            <div class="mb-2">${temaHTML}</div>
            <p class="text-gray-700 mb-3">${ticket.mensaje}</p>
            <div class="text-sm text-gray-600">
              <span>ğŸ‘¤ <strong>Solicitante:</strong> ${
                ticket.usuario_nombre || ticket.nombre
              }</span><br>
              <span>ğŸ“… <strong>Fecha:</strong> ${fecha}</span><br>
              <span>ğŸ“Š <strong>Estado:</strong> 
                <span class="px-2 py-1 rounded text-xs bg-gray-200">
                  ${ticket.estado.toUpperCase().replace("_", " ")}
                </span>
              </span>
            </div>
          </div>
        `;

        await cargarRespuestasTicket(ticket.id);

        const user = apiClient.getCurrentUser();
        if (user && ["admin", "secretaria"].includes(user.rol)) {
          respuestaSection.classList.remove("hidden");
        }

        modal.classList.remove("hidden");
      }

      async function cargarRespuestasTicket(ticketId) {
        try {
          const respuestas = await apiClient.getTicketResponses(ticketId);
          const listaRespuestas = document.getElementById("lista-respuestas");

          if (respuestas.length === 0) {
            listaRespuestas.innerHTML =
              '<p class="text-gray-500 text-sm">No hay respuestas aÃºn.</p>';
            return;
          }

          listaRespuestas.innerHTML = "";
          respuestas.forEach((respuesta) => {
            const respuestaDiv = document.createElement("div");
            respuestaDiv.className = "bg-gray-50 p-3 rounded mb-3";

            const fecha = new Date(
              respuesta.fecha_respuesta
            ).toLocaleDateString("es-ES");
            const hora = new Date(respuesta.fecha_respuesta).toLocaleTimeString(
              "es-ES"
            );

            respuestaDiv.innerHTML = `
              <div class="text-sm text-gray-600 mb-2">
                <strong>ğŸ‘©â€ğŸ’¼ ${respuesta.admin_nombre}</strong> â€¢ ${fecha} a las ${hora}
              </div>
              <p class="text-gray-800">${respuesta.respuesta}</p>
            `;

            listaRespuestas.appendChild(respuestaDiv);
          });
        } catch (error) {
          console.error("âŒ Error cargando respuestas:", error);
          document.getElementById("lista-respuestas").innerHTML =
            '<p class="text-red-500 text-sm">Error cargando respuestas.</p>';
        }
      }

      function cerrarModal() {
        document.getElementById("ticket-modal").classList.add("hidden");
        currentTicketId = null;
        document.getElementById("respuesta-texto").value = "";
      }

      async function responderTicket() {
        if (!currentTicketId) return;

        const respuesta = document
          .getElementById("respuesta-texto")
          .value.trim();
        const nuevoEstado = document.getElementById("nuevo-estado").value;

        if (!respuesta) {
          alert("âŒ La respuesta es requerida");
          return;
        }

        try {
          await apiClient.respondTicket(
            currentTicketId,
            respuesta,
            nuevoEstado
          );
          alert("âœ… Respuesta enviada exitosamente");

          await cargarRespuestasTicket(currentTicketId);
          await cargarTickets();

          document.getElementById("respuesta-texto").value = "";
        } catch (error) {
          alert(`âŒ Error: ${error.message}`);
        }
      }

      function mostrarMensajeForm(texto, tipo) {
        const mensaje = document.getElementById("form-mensaje");
        if (!mensaje) return;

        mensaje.textContent = texto;
        mensaje.className = "text-center text-sm mt-4";

        if (tipo === "success") mensaje.classList.add("text-green-600");
        else if (tipo === "error") mensaje.classList.add("text-red-600");
        else if (tipo === "info") mensaje.classList.add("text-blue-600");

        if (tipo === "success") {
          setTimeout(() => (mensaje.textContent = ""), 3000);
        }
      }

      function cerrarSesion() {
        apiClient.logout();
      }

      // Cerrar modal con Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") cerrarModal();
      });
    </script>
  </body>
</html>
