<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Tickets - Plataforma SecretarÃ­a</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <header class="bg-blue-900 text-white p-4 text-center">
      <h1 class="text-2xl font-bold">
        Plataforma SecretarÃ­a - Escuela de Ciencias Exactas
      </h1>
      <p class="text-sm">Universidad Sergio Arboleda</p>
    </header>

    <nav class="flex justify-between items-center bg-blue-700 text-white p-2">
      <div class="space-x-4">
        <a href="foro.html" class="hover:underline">Foro</a>
        <a href="publicaciones.html" class="hover:underline">Publicaciones</a>
        <a href="tickets.html" class="underline font-semibold">Tickets</a>
      </div>
      <div class="flex items-center space-x-3">
        <span id="rol-usuario" class="text-white text-sm"></span>
        <button
          onclick="cerrarSesion()"
          class="bg-red-500 px-3 py-1 rounded hover:bg-red-600 transition-colors"
        >
          Cerrar sesiÃ³n
        </button>
      </div>
    </nav>

    <div class="foro-bg">
      <main class="p-6">
        <section id="tickets">
          <!-- Header dinÃ¡mico segÃºn el rol -->
          <div class="mb-6">
            <h2
              id="tickets-title"
              class="text-2xl font-bold text-gray-800 mb-2"
            >
              ğŸ« Sistema de Tickets
            </h2>
            <p id="tickets-description" class="text-gray-600">
              GestiÃ³n de solicitudes estudiantiles
            </p>
          </div>

          <!-- ğŸ“ PANEL PARA ESTUDIANTES - Crear tickets -->
          <section id="estudiante-panel" class="mb-8">
            <div
              class="bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-lg shadow-lg"
            >
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <span class="text-3xl mr-3">ğŸ“</span>
                  <div>
                    <h2 class="text-2xl font-bold">Panel de Estudiante</h2>
                    <p class="text-blue-100">
                      EnvÃ­a solicitudes a la secretarÃ­a acadÃ©mica
                    </p>
                  </div>
                </div>

                <div class="bg-white rounded-lg p-6 text-gray-800">
                  <h3 class="text-xl font-semibold mb-4">
                    âœ‰ï¸ Crear Nueva Solicitud
                  </h3>

                  <form id="form-ticket" class="space-y-4">
                    <!-- TÃ­tulo -->
                    <div>
                      <label
                        for="titulo"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        TÃ­tulo de la solicitud (opcional)
                      </label>
                      <input
                        id="titulo"
                        type="text"
                        placeholder="Ej: Solicitud de certificado acadÃ©mico"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <p class="mt-1 text-sm text-gray-500">
                        Si no especificas un tÃ­tulo, se crearÃ¡ como "Solicitud
                        general"
                      </p>
                    </div>

                    <!-- Campo Tema -->
                    <div>
                      <label
                        for="tema"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        Tema de la solicitud <span class="text-red-500">*</span>
                      </label>
                      <select
                        id="tema"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        required
                      >
                        <option value="">Selecciona un tema...</option>
                        <option value="materia">ğŸ“š Materias y Horarios</option>
                        <option value="practicas">
                          ğŸ”¬ PrÃ¡cticas Profesionales
                        </option>
                        <option value="certificados">
                          ğŸ“„ Certificados y Documentos
                        </option>
                        <option value="matricula">ğŸ“ MatrÃ­cula y Pagos</option>
                        <option value="notas">ğŸ“Š Notas y Calificaciones</option>
                        <option value="tramites">
                          ğŸ“‹ TrÃ¡mites Administrativos
                        </option>
                        <option value="becas">ğŸ’° Becas y Ayudas</option>
                        <option value="otro">â“ Otro</option>
                      </select>
                    </div>

                    <!-- DescripciÃ³n -->
                    <div>
                      <label
                        for="mensaje"
                        class="block text-sm font-medium text-gray-700 mb-2"
                      >
                        DescripciÃ³n detallada
                        <span class="text-red-500">*</span>
                      </label>
                      <textarea
                        id="mensaje"
                        placeholder="Describe tu solicitud con el mayor detalle posible..."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        rows="5"
                        required
                      ></textarea>
                      <p class="mt-1 text-sm text-gray-500">
                        Incluye toda la informaciÃ³n relevante para que puedan
                        ayudarte mejor
                      </p>
                    </div>

                    <button
                      type="submit"
                      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center"
                    >
                      <span class="mr-2">ğŸ“¤</span>
                      Enviar Solicitud
                    </button>

                    <div
                      id="form-mensaje"
                      class="text-center text-sm mt-4"
                    ></div>
                  </form>
                </div>
              </div>
            </div>
          </section>

          <!-- ğŸ“‹ PANEL PARA SECRETARIAS -->
          <section id="secretaria-panel" class="hidden mb-8">
            <div
              class="bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg shadow-lg"
            >
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <span class="text-3xl mr-3">ğŸ“‹</span>
                  <div>
                    <h2 class="text-2xl font-bold">Panel de SecretarÃ­a</h2>
                    <p class="text-purple-100">
                      GestiÃ³n de solicitudes estudiantiles
                    </p>
                  </div>
                </div>

                <div class="bg-white rounded-lg p-6 text-gray-800">
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">
                      ğŸ“¬ Solicitudes Recibidas
                    </h3>
                    <div class="flex space-x-2">
                      <button
                        onclick="filtrarTickets('todos')"
                        class="px-3 py-1 bg-gray-200 rounded text-sm hover:bg-gray-300"
                        id="btn-todos"
                      >
                        Todos
                      </button>
                      <button
                        onclick="filtrarTickets('abierto')"
                        class="px-3 py-1 bg-green-200 rounded text-sm hover:bg-green-300"
                        id="btn-abiertos"
                      >
                        Abiertos
                      </button>
                      <button
                        onclick="filtrarTickets('en_proceso')"
                        class="px-3 py-1 bg-yellow-200 rounded text-sm hover:bg-yellow-300"
                        id="btn-proceso"
                      >
                        En Proceso
                      </button>
                      <button
                        onclick="filtrarTickets('cerrado')"
                        class="px-3 py-1 bg-red-200 rounded text-sm hover:bg-red-300"
                        id="btn-cerrados"
                      >
                        Cerrados
                      </button>
                    </div>
                  </div>

                  <div class="text-sm text-gray-600 mb-4">
                    <p>
                      <strong>ğŸ’¡ Instrucciones:</strong> Haz clic en cualquier
                      ticket para ver detalles y responder.
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- ğŸ‘‘ PANEL PARA ADMINS CON FILTRADO AVANZADO -->
          <section id="admin-tickets-panel" class="hidden mb-8">
            <div
              class="bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg shadow-lg"
            >
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <span class="text-3xl mr-3">ğŸ‘‘</span>
                  <div>
                    <h2 class="text-2xl font-bold">
                      Panel de AdministraciÃ³n de Tickets
                    </h2>
                    <p class="text-purple-100">
                      Control total del sistema de solicitudes estudiantiles
                    </p>
                  </div>
                </div>

                <div class="bg-white rounded-lg p-6 text-gray-800">
                  <!-- âœ… ESTADÃSTICAS GENERALES -->
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-green-600"
                        id="count-abiertos"
                      >
                        0
                      </div>
                      <div class="text-sm text-green-800">Abiertos</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-yellow-600"
                        id="count-proceso"
                      >
                        0
                      </div>
                      <div class="text-sm text-yellow-800">En Proceso</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-red-600"
                        id="count-cerrados"
                      >
                        0
                      </div>
                      <div class="text-sm text-red-800">Cerrados</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                      <div
                        class="text-2xl font-bold text-blue-600"
                        id="count-total"
                      >
                        0
                      </div>
                      <div class="text-sm text-blue-800">Total</div>
                    </div>
                  </div>

                  <!-- âœ… PANEL DE FILTROS AVANZADOS -->
                  <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-lg mb-4 flex items-center">
                      <span class="mr-2">ğŸ”</span>
                      Filtros Avanzados
                    </h4>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <!-- Filtro por Estado -->
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-700 mb-2"
                          >Estado</label
                        >
                        <select
                          id="filtro-estado"
                          class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="todos">ğŸ“‹ Todos los estados</option>
                          <option value="abierto">ğŸŸ¢ Abiertos</option>
                          <option value="en_proceso">ğŸŸ¡ En Proceso</option>
                          <option value="cerrado">ğŸ”´ Cerrados</option>
                        </select>
                      </div>

                      <!-- âœ… FILTRO POR CATEGORÃA/TEMA -->
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-700 mb-2"
                          >CategorÃ­a</label
                        >
                        <select
                          id="filtro-tema"
                          class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="todos">ğŸ“‚ Todas las categorÃ­as</option>
                          <option value="materia">
                            ğŸ“š Materias y Horarios
                          </option>
                          <option value="practicas">
                            ğŸ”¬ PrÃ¡cticas Profesionales
                          </option>
                          <option value="certificados">
                            ğŸ“„ Certificados y Documentos
                          </option>
                          <option value="matricula">
                            ğŸ“ MatrÃ­cula y Pagos
                          </option>
                          <option value="notas">
                            ğŸ“Š Notas y Calificaciones
                          </option>
                          <option value="tramites">
                            ğŸ“‹ TrÃ¡mites Administrativos
                          </option>
                          <option value="becas">ğŸ’° Becas y Ayudas</option>
                          <option value="otro">â“ Otro</option>
                        </select>
                      </div>

                      <!-- Filtro por Prioridad -->
                      <div>
                        <label
                          class="block text-sm font-medium text-gray-700 mb-2"
                          >Prioridad</label
                        >
                        <select
                          id="filtro-prioridad"
                          class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="todos">
                            âš¡ Todas las prioridades
                          </option>
                          <option value="alta">ğŸ”´ Alta</option>
                          <option value="media">ğŸŸ¡ Media</option>
                          <option value="baja">ğŸŸ¢ Baja</option>
                        </select>
                      </div>

                      <!-- BotÃ³n de aplicar filtros -->
                      <div class="flex items-end">
                        <button
                          onclick="aplicarFiltros()"
                          class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                        >
                          ğŸ” Filtrar
                        </button>
                      </div>
                    </div>

                    <!-- âœ… BOTONES DE FILTRO RÃPIDO POR CATEGORÃA -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <h5 class="text-sm font-medium text-gray-700 mb-3">
                        Filtros RÃ¡pidos por CategorÃ­a:
                      </h5>
                      <div class="flex flex-wrap gap-2">
                        <button
                          onclick="filtroRapidoTema('todos')"
                          class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors"
                          id="btn-tema-todos"
                        >
                          ğŸ“‚ Todas
                        </button>
                        <button
                          onclick="filtroRapidoTema('materia')"
                          class="px-3 py-1 bg-blue-100 hover:bg-blue-200 rounded text-sm transition-colors"
                          id="btn-tema-materia"
                        >
                          ğŸ“š Materias
                        </button>
                        <button
                          onclick="filtroRapidoTema('certificados')"
                          class="px-3 py-1 bg-green-100 hover:bg-green-200 rounded text-sm transition-colors"
                          id="btn-tema-certificados"
                        >
                          ğŸ“„ Certificados
                        </button>
                        <button
                          onclick="filtroRapidoTema('matricula')"
                          class="px-3 py-1 bg-yellow-100 hover:bg-yellow-200 rounded text-sm transition-colors"
                          id="btn-tema-matricula"
                        >
                          ğŸ“ MatrÃ­cula
                        </button>
                        <button
                          onclick="filtroRapidoTema('notas')"
                          class="px-3 py-1 bg-purple-100 hover:bg-purple-200 rounded text-sm transition-colors"
                          id="btn-tema-notas"
                        >
                          ğŸ“Š Notas
                        </button>
                        <button
                          onclick="filtroRapidoTema('practicas')"
                          class="px-3 py-1 bg-red-100 hover:bg-red-200 rounded text-sm transition-colors"
                          id="btn-tema-practicas"
                        >
                          ğŸ”¬ PrÃ¡cticas
                        </button>
                        <button
                          onclick="filtroRapidoTema('tramites')"
                          class="px-3 py-1 bg-indigo-100 hover:bg-indigo-200 rounded text-sm transition-colors"
                          id="btn-tema-tramites"
                        >
                          ğŸ“‹ TrÃ¡mites
                        </button>
                        <button
                          onclick="filtroRapidoTema('becas')"
                          class="px-3 py-1 bg-orange-100 hover:bg-orange-200 rounded text-sm transition-colors"
                          id="btn-tema-becas"
                        >
                          ğŸ’° Becas
                        </button>
                      </div>
                    </div>

                    <!-- âœ… INDICADOR DE FILTROS ACTIVOS -->
                    <div
                      id="filtros-activos"
                      class="mt-4 pt-4 border-t border-gray-200 hidden"
                    >
                      <h5 class="text-sm font-medium text-gray-700 mb-2">
                        Filtros Activos:
                      </h5>
                      <div
                        id="lista-filtros-activos"
                        class="flex flex-wrap gap-2"
                      >
                        <!-- Los filtros activos se muestran aquÃ­ -->
                      </div>
                      <button
                        onclick="limpiarFiltros()"
                        class="mt-2 text-sm text-red-600 hover:text-red-800 underline"
                      >
                        âŒ Limpiar todos los filtros
                      </button>
                    </div>
                  </div>

                  <!-- âœ… ESTADÃSTICAS POR CATEGORÃA -->
                  <div
                    id="estadisticas-categorias"
                    class="bg-blue-50 rounded-lg p-4 mb-6 hidden"
                  >
                    <h4 class="font-semibold text-lg mb-4 flex items-center">
                      <span class="mr-2">ğŸ“Š</span>
                      EstadÃ­sticas por CategorÃ­a
                    </h4>
                    <div
                      id="stats-por-categoria"
                      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"
                    >
                      <!-- Las estadÃ­sticas se cargan aquÃ­ dinÃ¡micamente -->
                    </div>
                  </div>

                  <!-- âœ… INFORMACIÃ“N Y CONTROLES -->
                  <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">ğŸ“‹ GestiÃ³n de Tickets</h3>
                    <div class="flex space-x-2">
                      <button
                        onclick="exportarTickets()"
                        class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition-colors"
                      >
                        ğŸ“Š Exportar
                      </button>
                      <button
                        onclick="cargarTickets()"
                        class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors"
                      >
                        ğŸ”„ Actualizar
                      </button>
                    </div>
                  </div>

                  <div class="text-sm text-gray-600 mb-4">
                    <p>
                      <strong>ğŸ’¡ Instrucciones:</strong> Usa los filtros para
                      organizar tickets por categorÃ­a y estado. Haz clic en
                      cualquier ticket para ver detalles y responder.
                    </p>
                    <p class="mt-1" id="resultados-info">
                      Mostrando todos los tickets...
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- InformaciÃ³n del sistema -->
          <div
            class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500"
          >
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
              <div class="flex items-center">
                <span
                  class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"
                ></span>
                <span><strong>ABIERTO:</strong> Ticket reciÃ©n creado</span>
              </div>
              <div class="flex items-center">
                <span
                  class="inline-block w-3 h-3 bg-yellow-500 rounded-full mr-2"
                ></span>
                <span><strong>EN PROCESO:</strong> Siendo atendido</span>
              </div>
              <div class="flex items-center">
                <span
                  class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"
                ></span>
                <span><strong>CERRADO:</strong> Resuelto o finalizado</span>
              </div>
            </div>
          </div>

          <!-- Lista de tickets -->
          <div class="bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-4">
              <h3
                id="tickets-list-title"
                class="text-xl font-semibold text-gray-800"
              >
                ğŸ“‹ Tickets
              </h3>
              <button
                onclick="cargarTickets()"
                class="text-blue-600 hover:text-blue-800 text-sm"
                title="Actualizar lista"
              >
                ğŸ”„ Actualizar
              </button>
            </div>

            <div id="loading-tickets" class="text-center py-8">
              <div
                class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"
              ></div>
              <p class="mt-2 text-gray-600">Cargando tickets...</p>
            </div>

            <div id="ticket-lista" class="space-y-4">
              <!-- Los tickets se cargan aquÃ­ dinÃ¡micamente -->
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- âœ… MODAL PARA VER/RESPONDER TICKET -->
    <div
      id="ticket-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-800">
              ğŸ“„ Detalles del Ticket
            </h3>
            <button
              onclick="cerrarModal()"
              class="text-gray-500 hover:text-gray-700 text-2xl"
            >
              Ã—
            </button>
          </div>

          <div id="ticket-content">
            <!-- Contenido del ticket se genera aquÃ­ -->
          </div>

          <!-- âœ… SECCIÃ“N PARA RESPUESTAS EXISTENTES -->
          <div id="respuestas-existentes" class="mt-6 border-t pt-4">
            <h4 class="font-semibold mb-3">ğŸ’¬ Respuestas</h4>
            <div id="lista-respuestas">
              <!-- Las respuestas se cargan aquÃ­ -->
            </div>
          </div>

          <!-- âœ… SECCIÃ“N PARA RESPONDER (solo secretarias y admins) -->
          <div id="respuesta-section" class="hidden mt-6 border-t pt-4">
            <h4 class="font-semibold mb-3">ğŸ’¬ Responder al Ticket</h4>
            <form id="form-respuesta">
              <textarea
                id="respuesta-texto"
                placeholder="Escribe tu respuesta..."
                class="w-full p-3 border border-gray-300 rounded-lg mb-3"
                rows="4"
                required
              ></textarea>

              <div class="flex justify-between items-center">
                <select
                  id="nuevo-estado"
                  class="border border-gray-300 rounded px-3 py-2"
                >
                  <option value="en_proceso">En Proceso</option>
                  <option value="cerrado">Cerrado/Resuelto</option>
                </select>

                <button
                  type="submit"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
                >
                  ğŸ“¤ Enviar Respuesta
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="js/api-client.js"></script>
    <script src="js/simple-role.js"></script>

    <script>
      let currentFilter = "todos";
      let allTickets = [];
      let currentTicketId = null;

      // âœ… NUEVAS VARIABLES PARA FILTRADO AVANZADO
      let currentFilters = {
        estado: "todos",
        tema: "todos",
        prioridad: "todos",
      };
      let currentPage = 1;
      let estadisticasGenerales = null;

      document.addEventListener("DOMContentLoaded", async () => {
        console.log("ğŸš€ Iniciando sistema de tickets...");

        if (!apiClient.sessionId) {
          console.log("âŒ No hay sesiÃ³n, redirigiendo...");
          window.location.href = "index.html";
          return;
        }

        await verificarRolYMostrarPanel();
        configurarEventListeners();
        await cargarTickets();
      });

      async function verificarRolYMostrarPanel() {
        try {
          const user = apiClient.getCurrentUser();
          console.log("ğŸ‘¤ Usuario actual:", user);

          if (!user) {
            try {
              const apiUser = await apiClient.getUserInfo();
              verificarYMostrarPorRol(apiUser);
            } catch (error) {
              console.error("âŒ Error obteniendo usuario de API:", error);
              mostrarPanelEstudiante();
            }
          } else {
            verificarYMostrarPorRol(user);
          }
        } catch (error) {
          console.error("âŒ Error verificando rol:", error);
          mostrarPanelEstudiante();
        }
      }

      function verificarYMostrarPorRol(user) {
        console.log("ğŸ” Verificando rol:", user.rol);

        const rolesEstudiante = ["estudiante", "usuario", "student"];
        const rolesAdmin = ["admin", "administrator"];
        const rolesSecretaria = ["secretaria", "secretary"];

        if (rolesEstudiante.includes(user.rol)) {
          console.log("âœ… Usuario es estudiante, mostrando panel...");
          mostrarPanelEstudiante();
        } else if (rolesSecretaria.includes(user.rol)) {
          console.log("âœ… Usuario es secretaria, mostrando panel...");
          mostrarPanelSecretaria();
        } else if (rolesAdmin.includes(user.rol)) {
          console.log("âœ… Usuario es admin, mostrando panel...");
          mostrarPanelAdmin();
        } else {
          console.log(
            `âš ï¸ Rol no reconocido: "${user.rol}", mostrando panel de estudiante por defecto`
          );
          mostrarPanelEstudiante();
        }
      }

      function mostrarPanelEstudiante() {
        console.log("ğŸ“ Mostrando panel de estudiante...");

        document.getElementById("estudiante-panel")?.classList.remove("hidden");
        document.getElementById("secretaria-panel")?.classList.add("hidden");
        document.getElementById("admin-tickets-panel")?.classList.add("hidden");

        document.getElementById("tickets-title").textContent =
          "ğŸ« Mis Solicitudes";
        document.getElementById("tickets-description").textContent =
          "EnvÃ­a solicitudes a la secretarÃ­a acadÃ©mica";
        document.getElementById("tickets-list-title").textContent =
          "ğŸ“‹ Mis Tickets";
      }

      function mostrarPanelSecretaria() {
        console.log("ğŸ“‹ Mostrando panel de secretaria...");
        document.getElementById("secretaria-panel")?.classList.remove("hidden");
        document.getElementById("estudiante-panel")?.classList.add("hidden");
        document.getElementById("admin-tickets-panel")?.classList.add("hidden");

        document.getElementById("tickets-title").textContent =
          "ğŸ“¬ Solicitudes Estudiantiles";
        document.getElementById("tickets-description").textContent =
          "Gestiona las solicitudes de los estudiantes";
        document.getElementById("tickets-list-title").textContent =
          "ğŸ“‹ Tickets Recibidos";
      }

      function mostrarPanelAdmin() {
        console.log("ğŸ‘‘ Mostrando panel de admin...");
        document
          .getElementById("admin-tickets-panel")
          ?.classList.remove("hidden");
        document.getElementById("estudiante-panel")?.classList.add("hidden");
        document.getElementById("secretaria-panel")?.classList.add("hidden");

        document.getElementById("tickets-title").textContent =
          "ğŸ‘‘ AdministraciÃ³n de Tickets";
        document.getElementById("tickets-description").textContent =
          "Control total del sistema de solicitudes";
        document.getElementById("tickets-list-title").textContent =
          "ğŸ“‹ Todos los Tickets";
      }

      function configurarEventListeners() {
        const formTicket = document.getElementById("form-ticket");
        if (formTicket) {
          formTicket.addEventListener("submit", async (e) => {
            e.preventDefault();
            await crearTicket();
          });
        }

        const formRespuesta = document.getElementById("form-respuesta");
        if (formRespuesta) {
          formRespuesta.addEventListener("submit", async (e) => {
            e.preventDefault();
            await responderTicket();
          });
        }
      }

      // ==================
      // âœ… SISTEMA DE FILTRADO AVANZADO
      // ==================

      async function aplicarFiltros() {
        // Obtener valores de los selectores
        currentFilters.estado =
          document.getElementById("filtro-estado")?.value || "todos";
        currentFilters.tema =
          document.getElementById("filtro-tema")?.value || "todos";
        currentFilters.prioridad =
          document.getElementById("filtro-prioridad")?.value || "todos";

        console.log("ğŸ” Aplicando filtros:", currentFilters);

        // Resetear pÃ¡gina
        currentPage = 1;

        // Cargar tickets con filtros
        await cargarTicketsConFiltros();

        // Actualizar UI de filtros activos
        mostrarFiltrosActivos();

        // Scroll al inicio de la lista
        document
          .getElementById("ticket-lista")
          ?.scrollIntoView({ behavior: "smooth" });
      }

      async function filtroRapidoTema(tema) {
        console.log("âš¡ Filtro rÃ¡pido por tema:", tema);

        // Actualizar selector y filtro actual
        const selectorTema = document.getElementById("filtro-tema");
        if (selectorTema) {
          selectorTema.value = tema;
        }
        currentFilters.tema = tema;

        // Resetear pÃ¡gina
        currentPage = 1;

        // Aplicar filtro
        await cargarTicketsConFiltros();
        mostrarFiltrosActivos();

        // Actualizar botones de filtro rÃ¡pido
        actualizarBotonesFiltroRapido(tema);
      }

      // âœ… TAMBIÃ‰N CORREGIR cargarTicketsConFiltros
      async function cargarTicketsConFiltros() {
        const loadingElement = document.getElementById("loading-tickets");
        const listaElement = document.getElementById("ticket-lista");

        try {
          if (loadingElement) loadingElement.style.display = "block";
          if (listaElement) listaElement.innerHTML = "";

          console.log("ğŸ” Solicitando tickets con filtros:", currentFilters);

          // âœ… LLAMAR API CON FILTROS
          const response = await apiClient.getTicketsWithFilters(
            currentFilters,
            currentPage
          );

          console.log("ğŸ“¡ Respuesta completa de la API:", response);

          // âœ… VALIDAR Y EXTRAER TICKETS DE LA RESPUESTA
          let tickets = [];

          if (response && response.tickets && Array.isArray(response.tickets)) {
            tickets = response.tickets;
            console.log(
              "âœ… Formato nuevo: encontrados",
              tickets.length,
              "tickets"
            );
          } else if (Array.isArray(response)) {
            tickets = response;
            console.log(
              "âœ… Formato anterior: encontrados",
              tickets.length,
              "tickets"
            );
          } else {
            console.error("âŒ Respuesta en formato inesperado:", response);
            tickets = [];
          }

          allTickets = tickets;
          const pagination = response.pagination;
          estadisticasGenerales = response.estadisticas;

          console.log(
            `âœ… ${tickets.length} tickets procesados con filtros:`,
            currentFilters
          );

          if (loadingElement) loadingElement.style.display = "none";

          // Actualizar contadores y estadÃ­sticas
          if (estadisticasGenerales) {
            actualizarContadoresYEstadisticas(estadisticasGenerales);
          } else {
            actualizarContadores(tickets);
          }

          // Mostrar tickets (ya con validaciÃ³n)
          mostrarTickets(tickets);

          // Actualizar informaciÃ³n de resultados
          actualizarInfoResultados(tickets.length, currentFilters);
        } catch (error) {
          console.error("âŒ Error cargando tickets con filtros:", error);
          if (loadingElement) loadingElement.style.display = "none";
          if (listaElement) {
            listaElement.innerHTML = `<div class="text-center text-red-500 py-8">Error: ${error.message}</div>`;
          }
        }
      }

      // âœ… ACTUALIZAR API CLIENT - MÃ©todo para obtener tickets con filtros
      apiClient.getTicketsWithFilters = async function (
        filtros = {},
        page = 1
      ) {
        const params = new URLSearchParams();

        if (filtros.estado && filtros.estado !== "todos") {
          params.append("estado", filtros.estado);
        }
        if (filtros.tema && filtros.tema !== "todos") {
          params.append("tema", filtros.tema);
        }
        if (filtros.prioridad && filtros.prioridad !== "todos") {
          params.append("prioridad", filtros.prioridad);
        }

        params.append("page", page);
        params.append("limit", 50);

        const url = `${this.baseURL}/tickets?${params.toString()}`;

        try {
          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${this.sessionId}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          return await response.json();
        } catch (error) {
          console.error("âŒ Error en getTicketsWithFilters:", error);
          throw error;
        }
      };

      function mostrarFiltrosActivos() {
        const filtrosActivosDiv = document.getElementById("filtros-activos");
        const listaFiltrosDiv = document.getElementById(
          "lista-filtros-activos"
        );

        if (!filtrosActivosDiv || !listaFiltrosDiv) return;

        const filtrosActivos = [];

        if (currentFilters.estado !== "todos") {
          filtrosActivos.push({
            tipo: "estado",
            valor: currentFilters.estado,
            texto: getEstadoNombre(currentFilters.estado),
            color: "bg-blue-100 text-blue-800",
          });
        }

        if (currentFilters.tema !== "todos") {
          filtrosActivos.push({
            tipo: "tema",
            valor: currentFilters.tema,
            texto: getTemaNombre(currentFilters.tema),
            color: "bg-green-100 text-green-800",
          });
        }

        if (currentFilters.prioridad !== "todos") {
          filtrosActivos.push({
            tipo: "prioridad",
            valor: currentFilters.prioridad,
            texto: getPrioridadNombre(currentFilters.prioridad),
            color: "bg-yellow-100 text-yellow-800",
          });
        }

        if (filtrosActivos.length > 0) {
          filtrosActivosDiv.classList.remove("hidden");
          listaFiltrosDiv.innerHTML = filtrosActivos
            .map(
              (filtro) =>
                `<span class="px-2 py-1 rounded text-xs ${filtro.color} flex items-center">
              ${filtro.texto}
              <button onclick="quitarFiltro('${filtro.tipo}')" class="ml-1 text-red-500 hover:text-red-700">Ã—</button>
            </span>`
            )
            .join("");
        } else {
          filtrosActivosDiv.classList.add("hidden");
        }
      }

      async function quitarFiltro(tipoFiltro) {
        currentFilters[tipoFiltro] = "todos";

        // Actualizar selector correspondiente
        const selector = document.getElementById(`filtro-${tipoFiltro}`);
        if (selector) {
          selector.value = "todos";
        }

        // Recargar con nuevos filtros
        await cargarTicketsConFiltros();
        mostrarFiltrosActivos();

        if (tipoFiltro === "tema") {
          actualizarBotonesFiltroRapido("todos");
        }
      }

      async function limpiarFiltros() {
        currentFilters = {
          estado: "todos",
          tema: "todos",
          prioridad: "todos",
        };

        // Resetear selectores
        const selectorEstado = document.getElementById("filtro-estado");
        const selectorTema = document.getElementById("filtro-tema");
        const selectorPrioridad = document.getElementById("filtro-prioridad");

        if (selectorEstado) selectorEstado.value = "todos";
        if (selectorTema) selectorTema.value = "todos";
        if (selectorPrioridad) selectorPrioridad.value = "todos";

        // Recargar tickets
        await cargarTicketsConFiltros();
        mostrarFiltrosActivos();
        actualizarBotonesFiltroRapido("todos");
      }

      function actualizarBotonesFiltroRapido(temaActivo) {
        // Limpiar estados anteriores
        document.querySelectorAll('[id^="btn-tema-"]').forEach((btn) => {
          btn.classList.remove("bg-blue-500", "text-white", "font-bold");
          btn.classList.add("hover:bg-gray-300");
        });

        // Activar botÃ³n actual
        const btnActivo = document.getElementById(`btn-tema-${temaActivo}`);
        if (btnActivo) {
          btnActivo.classList.add("bg-blue-500", "text-white", "font-bold");
          btnActivo.classList.remove("hover:bg-gray-300");
        }
      }

      function actualizarContadoresYEstadisticas(estadisticas) {
        const user = apiClient.getCurrentUser();
        if (user?.rol !== "admin") return;

        // Contadores generales
        let contadores = {
          abierto: 0,
          en_proceso: 0,
          cerrado: 0,
          total: estadisticas.total_general || 0,
        };

        // Calcular contadores desde estadÃ­sticas por tema
        if (estadisticas.por_tema) {
          estadisticas.por_tema.forEach((tema) => {
            contadores.abierto += tema.abiertos;
            contadores.en_proceso += tema.en_proceso;
            contadores.cerrado += tema.cerrados;
          });
        }

        // Actualizar UI
        const countAbiertos = document.getElementById("count-abiertos");
        const countProceso = document.getElementById("count-proceso");
        const countCerrados = document.getElementById("count-cerrados");
        const countTotal = document.getElementById("count-total");

        if (countAbiertos) countAbiertos.textContent = contadores.abierto;
        if (countProceso) countProceso.textContent = contadores.en_proceso;
        if (countCerrados) countCerrados.textContent = contadores.cerrado;
        if (countTotal) countTotal.textContent = contadores.total;

        // Mostrar estadÃ­sticas por categorÃ­a
        mostrarEstadisticasPorCategoria(estadisticas.por_tema);
      }

      function mostrarEstadisticasPorCategoria(estadisticasTemas) {
        const statsContainer = document.getElementById(
          "estadisticas-categorias"
        );
        const statsGrid = document.getElementById("stats-por-categoria");

        if (!statsContainer || !statsGrid) return;

        if (!estadisticasTemas || estadisticasTemas.length === 0) {
          statsContainer.classList.add("hidden");
          return;
        }

        statsContainer.classList.remove("hidden");

        statsGrid.innerHTML = estadisticasTemas
          .map((tema) => {
            const porcentajeResueltos =
              tema.total > 0
                ? Math.round((tema.cerrados / tema.total) * 100)
                : 0;

            return `
            <div class="bg-white p-3 rounded-lg border border-gray-200 hover:shadow-md transition-shadow cursor-pointer" 
                 onclick="filtroRapidoTema('${tema.tema}')">
              <div class="flex items-center justify-between mb-2">
                <h5 class="font-medium text-sm">${getTemaNombre(tema.tema)}</h5>
                <span class="text-xs bg-gray-100 px-2 py-1 rounded">${
                  tema.total
                }</span>
              </div>
              <div class="space-y-1">
                <div class="flex justify-between text-xs">
                  <span class="text-green-600">ğŸŸ¢ ${tema.abiertos}</span>
                  <span class="text-yellow-600">ğŸŸ¡ ${tema.en_proceso}</span>
                  <span class="text-red-600">ğŸ”´ ${tema.cerrados}</span>
                </div>
                <div class="text-xs text-gray-500 text-center">${porcentajeResueltos}% resueltos</div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      function actualizarInfoResultados(cantidadTickets, filtros) {
        const infoElement = document.getElementById("resultados-info");
        if (!infoElement) return;

        let mensaje = `Mostrando ${cantidadTickets} ticket${
          cantidadTickets !== 1 ? "s" : ""
        }`;

        const filtrosAplicados = [];
        if (filtros.estado !== "todos")
          filtrosAplicados.push(`estado: ${getEstadoNombre(filtros.estado)}`);
        if (filtros.tema !== "todos")
          filtrosAplicados.push(`categorÃ­a: ${getTemaNombre(filtros.tema)}`);
        if (filtros.prioridad !== "todos")
          filtrosAplicados.push(
            `prioridad: ${getPrioridadNombre(filtros.prioridad)}`
          );

        if (filtrosAplicados.length > 0) {
          mensaje += ` con filtros: ${filtrosAplicados.join(", ")}`;
        }

        infoElement.textContent = mensaje;
      }

      async function exportarTickets() {
        try {
          const tickets = allTickets;
          if (tickets.length === 0) {
            alert("No hay tickets para exportar");
            return;
          }

          let csv = "Fecha,TÃ­tulo,Usuario,CategorÃ­a,Estado,Prioridad,Mensaje\n";

          tickets.forEach((ticket) => {
            const fecha = new Date(ticket.fecha_creacion).toLocaleDateString();
            const titulo = `"${(ticket.titulo || "Sin tÃ­tulo").replace(
              /"/g,
              '""'
            )}"`;
            const usuario = `"${ticket.usuario_nombre || "Sin usuario"}"`;
            const categoria = getTemaNombre(ticket.tema || "otro");
            const estado = ticket.estado;
            const prioridad = ticket.prioridad || "media";
            const mensaje = `"${ticket.mensaje.replace(/"/g, '""')}"`;

            csv += `${fecha},${titulo},${usuario},${categoria},${estado},${prioridad},${mensaje}\n`;
          });

          // Crear y descargar archivo
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          link.setAttribute(
            "download",
            `tickets_${new Date().toISOString().split("T")[0]}.csv`
          );
          link.style.visibility = "hidden";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          console.log("âœ… Tickets exportados exitosamente");
        } catch (error) {
          console.error("âŒ Error exportando tickets:", error);
          alert("Error al exportar tickets: " + error.message);
        }
      }

      // ==================
      // FUNCIONES ORIGINALES DE TICKETS
      // ==================

      async function cargarTickets() {
        const user = apiClient.getCurrentUser();

        if (user?.rol === "admin") {
          // Para admins, usar sistema de filtros
          await cargarTicketsConFiltros();
        } else {
          // Para estudiantes/secretarias, usar mÃ©todo original
          await cargarTicketsOriginal();
        }
      }

      /// âœ… FUNCIÃ“N cargarTicketsOriginal CORREGIDA
      // Reemplazar esta funciÃ³n en tickets.html

      async function cargarTicketsOriginal() {
        const loadingElement = document.getElementById("loading-tickets");
        const listaElement = document.getElementById("ticket-lista");

        try {
          if (loadingElement) loadingElement.style.display = "block";
          if (listaElement) listaElement.innerHTML = "";

          console.log("ğŸ“¡ Solicitando tickets (mÃ©todo original)...");
          const response = await apiClient.getTickets();

          console.log("ğŸ“¡ Respuesta de getTickets:", response);
          console.log("ğŸ“¡ Tipo de respuesta:", typeof response);
          console.log("ğŸ“¡ Es array?", Array.isArray(response));

          // âœ… VALIDAR Y EXTRAER TICKETS DE LA RESPUESTA
          let tickets = [];

          if (Array.isArray(response)) {
            // Formato directo: [ticket1, ticket2, ...]
            tickets = response;
            console.log(
              "âœ… Formato directo: encontrados",
              tickets.length,
              "tickets"
            );
          } else if (
            response &&
            response.tickets &&
            Array.isArray(response.tickets)
          ) {
            // Formato con wrapper: { tickets: [ticket1, ticket2, ...] }
            tickets = response.tickets;
            console.log(
              "âœ… Formato con wrapper: encontrados",
              tickets.length,
              "tickets"
            );
          } else if (response && typeof response === "object") {
            // Si es un objeto pero no tiene tickets, intentar convertir
            console.warn(
              "âš ï¸ Respuesta es objeto pero no tiene array de tickets:",
              response
            );
            tickets = [];
          } else {
            // Respuesta completamente invÃ¡lida
            console.error("âŒ Respuesta invÃ¡lida de getTickets:", response);
            tickets = [];
          }

          // âœ… VALIDAR QUE CADA ELEMENTO SEA UN TICKET VÃLIDO
          const ticketsValidos = tickets.filter((ticket) => {
            if (!ticket || typeof ticket !== "object") {
              console.warn("âš ï¸ Ticket invÃ¡lido filtrado:", ticket);
              return false;
            }
            return true;
          });

          allTickets = ticketsValidos;
          console.log(
            `âœ… ${ticketsValidos.length} tickets vÃ¡lidos cargados (de ${tickets.length} recibidos)`
          );

          if (loadingElement) loadingElement.style.display = "none";

          // Actualizar contadores y mostrar tickets
          actualizarContadores(ticketsValidos);
          mostrarTickets(ticketsValidos);

          // Si no hay tickets, mostrar mensaje informativo
          if (ticketsValidos.length === 0) {
            console.log("ğŸ“­ No hay tickets para mostrar");
          }
        } catch (error) {
          console.error("âŒ Error cargando tickets:", error);
          console.error("âŒ Stack trace:", error.stack);

          if (loadingElement) loadingElement.style.display = "none";
          if (listaElement) {
            listaElement.innerHTML = `
        <div class="text-center text-red-500 py-8">
          <h3 class="text-lg font-semibold mb-2">Error cargando tickets</h3>
          <p class="mb-2">${error.message}</p>
          <button onclick="cargarTickets()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            ğŸ”„ Intentar nuevamente
          </button>
        </div>
      `;
          }
        }
      }

      function mostrarTickets(tickets) {
        const listaElement = document.getElementById("ticket-lista");

        if (!listaElement) {
          console.error("âŒ No se encontrÃ³ elemento ticket-lista");
          return;
        }

        // âœ… VALIDAR QUE tickets SEA UN ARRAY
        if (!tickets) {
          console.error("âŒ tickets es undefined o null");
          listaElement.innerHTML =
            '<div class="text-center text-red-500 py-8">Error: No se pudieron cargar los tickets</div>';
          return;
        }

        if (!Array.isArray(tickets)) {
          console.error("âŒ tickets no es un array:", typeof tickets, tickets);
          listaElement.innerHTML =
            '<div class="text-center text-red-500 py-8">Error: Formato de datos incorrecto</div>';
          return;
        }

        if (tickets.length === 0) {
          listaElement.innerHTML =
            '<div class="text-center text-gray-500 py-8">No hay tickets</div>';
          return;
        }

        console.log(`âœ… Mostrando ${tickets.length} tickets vÃ¡lidos`);
        listaElement.innerHTML = "";

        tickets.forEach((ticket) => {
          // âœ… VALIDAR QUE CADA ticket SEA UN OBJETO VÃLIDO
          if (!ticket || typeof ticket !== "object") {
            console.warn("âš ï¸ Ticket invÃ¡lido:", ticket);
            return; // Saltar este ticket
          }

          const item = document.createElement("div");
          item.className =
            "bg-white p-4 rounded border-l-4 shadow-sm hover:shadow-md transition-shadow cursor-pointer";

          const estadoColors = {
            abierto: "border-green-500 bg-green-50",
            en_proceso: "border-yellow-500 bg-yellow-50",
            cerrado: "border-red-500 bg-red-50",
          };

          item.className +=
            " " + (estadoColors[ticket.estado] || "border-gray-500");

          // âœ… VALIDAR FECHA ANTES DE FORMATEAR
          let fecha = "Fecha no disponible";
          try {
            if (ticket.fecha_creacion) {
              fecha = new Date(ticket.fecha_creacion).toLocaleDateString(
                "es-ES"
              );
            }
          } catch (e) {
            console.warn("âš ï¸ Error formateando fecha:", e);
          }

          // âœ… MOSTRAR TEMA SI EXISTE
          const temaHTML = ticket.tema
            ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2">${getTemaNombre(
                ticket.tema
              )}</span>`
            : "";

          item.innerHTML = `
      <div class="flex justify-between items-start mb-2">
        <h4 class="font-semibold text-lg">${
          ticket.titulo || "Solicitud General"
        }</h4>
        <span class="text-xs px-2 py-1 rounded-full bg-gray-200">
          ${(ticket.estado || "desconocido").toUpperCase().replace("_", " ")}
        </span>
      </div>
      <div class="mb-2">
        ${temaHTML}
      </div>
      <p class="text-gray-700 mb-2 line-clamp-2">${
        ticket.mensaje || "Sin mensaje"
      }</p>
      <div class="text-sm text-gray-500">
        <span>ğŸ‘¤ ${
          ticket.usuario_nombre || ticket.nombre || "Usuario desconocido"
        }</span>
        <span class="float-right">ğŸ“… ${fecha}</span>
      </div>
    `;

          item.onclick = () => abrirModalTicket(ticket);
          listaElement.appendChild(item);
        });
      }

      function filtrarTickets(estado) {
        currentFilter = estado;

        // Actualizar botones activos
        document.querySelectorAll('[id^="btn-"]').forEach((btn) => {
          btn.classList.remove("bg-blue-500", "text-white");
          btn.classList.add("bg-gray-200");
        });

        const btnId = estado === "todos" ? "btn-todos" : `btn-${estado}`;
        const btnAdmin =
          document.getElementById(`btn-admin-${estado}`) ||
          document.getElementById("btn-admin-todos");

        document
          .getElementById(btnId)
          ?.classList.add("bg-blue-500", "text-white");
        btnAdmin?.classList.add("bg-blue-500", "text-white");

        let ticketsFiltrados = allTickets;
        if (estado !== "todos") {
          ticketsFiltrados = allTickets.filter(
            (ticket) => ticket.estado === estado
          );
        }

        mostrarTickets(ticketsFiltrados);
      }

      function actualizarContadores(tickets) {
        const user = apiClient.getCurrentUser();
        if (user?.rol !== "admin") return;

        const contadores = {
          abierto: tickets.filter((t) => t.estado === "abierto").length,
          en_proceso: tickets.filter((t) => t.estado === "en_proceso").length,
          cerrado: tickets.filter((t) => t.estado === "cerrado").length,
          total: tickets.length,
        };

        const countAbiertos = document.getElementById("count-abiertos");
        const countProceso = document.getElementById("count-proceso");
        const countCerrados = document.getElementById("count-cerrados");
        const countTotal = document.getElementById("count-total");

        if (countAbiertos) countAbiertos.textContent = contadores.abierto;
        if (countProceso) countProceso.textContent = contadores.en_proceso;
        if (countCerrados) countCerrados.textContent = contadores.cerrado;
        if (countTotal) countTotal.textContent = contadores.total;
      }

      async function crearTicket() {
        const titulo = document.getElementById("titulo")?.value.trim() || null;
        const tema = document.getElementById("tema")?.value.trim();
        const mensaje = document.getElementById("mensaje")?.value.trim();

        if (!tema) {
          mostrarMensajeForm("âŒ Debes seleccionar un tema", "error");
          return;
        }

        if (!mensaje) {
          mostrarMensajeForm("âŒ El mensaje es requerido", "error");
          return;
        }

        try {
          mostrarMensajeForm("ğŸ”„ Enviando solicitud...", "info");

          const ticketData = {
            titulo: titulo || `Solicitud sobre ${getTemaNombre(tema)}`,
            mensaje: `[${getTemaNombre(tema)}] ${mensaje}`,
            tema: tema,
          };

          await apiClient.createTicket(ticketData);

          mostrarMensajeForm("âœ… Solicitud enviada exitosamente", "success");

          const tituloInput = document.getElementById("titulo");
          const temaInput = document.getElementById("tema");
          const mensajeInput = document.getElementById("mensaje");

          if (tituloInput) tituloInput.value = "";
          if (temaInput) temaInput.value = "";
          if (mensajeInput) mensajeInput.value = "";

          await cargarTickets();
        } catch (error) {
          console.error("âŒ Error creando ticket:", error);
          mostrarMensajeForm(`âŒ Error: ${error.message}`, "error");
        }
      }

      async function abrirModalTicket(ticket) {
        currentTicketId = ticket.id;
        const modal = document.getElementById("ticket-modal");
        const content = document.getElementById("ticket-content");
        const respuestaSection = document.getElementById("respuesta-section");

        if (!modal || !content) return;

        const fecha = new Date(ticket.fecha_creacion).toLocaleDateString(
          "es-ES"
        );
        const temaHTML = ticket.tema
          ? `<span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">${getTemaNombre(
              ticket.tema
            )}</span>`
          : "";

        content.innerHTML = `
          <div class="border-l-4 border-blue-500 bg-blue-50 p-4 mb-4">
            <h4 class="font-bold text-lg mb-2">${
              ticket.titulo || "Solicitud General"
            }</h4>
            <div class="mb-2">${temaHTML}</div>
            <p class="text-gray-700 mb-3">${ticket.mensaje}</p>
            <div class="text-sm text-gray-600">
              <span>ğŸ‘¤ <strong>Solicitante:</strong> ${
                ticket.usuario_nombre || ticket.nombre
              }</span><br>
              <span>ğŸ“… <strong>Fecha:</strong> ${fecha}</span><br>
              <span>ğŸ“Š <strong>Estado:</strong> 
                <span class="px-2 py-1 rounded text-xs bg-gray-200">
                  ${ticket.estado.toUpperCase().replace("_", " ")}
                </span>
              </span>
            </div>
          </div>
        `;

        // Cargar respuestas existentes
        await cargarRespuestasTicket(ticket.id);

        const user = apiClient.getCurrentUser();
        if (
          user &&
          ["admin", "secretaria"].includes(user.rol) &&
          respuestaSection
        ) {
          respuestaSection.classList.remove("hidden");
        }

        modal.classList.remove("hidden");
      }

      async function cargarRespuestasTicket(ticketId) {
        try {
          const respuestas = await apiClient.getTicketResponses(ticketId);
          const listaRespuestas = document.getElementById("lista-respuestas");

          if (!listaRespuestas) return;

          if (respuestas.length === 0) {
            listaRespuestas.innerHTML =
              '<p class="text-gray-500 text-sm">No hay respuestas aÃºn.</p>';
            return;
          }

          listaRespuestas.innerHTML = "";
          respuestas.forEach((respuesta) => {
            const respuestaDiv = document.createElement("div");
            respuestaDiv.className = "bg-gray-50 p-3 rounded mb-3";

            const fecha = new Date(
              respuesta.fecha_respuesta
            ).toLocaleDateString("es-ES");
            const hora = new Date(respuesta.fecha_respuesta).toLocaleTimeString(
              "es-ES"
            );

            respuestaDiv.innerHTML = `
              <div class="text-sm text-gray-600 mb-2">
                <strong>ğŸ‘©â€ğŸ’¼ ${respuesta.admin_nombre}</strong> â€¢ ${fecha} a las ${hora}
              </div>
              <p class="text-gray-800">${respuesta.respuesta}</p>
            `;

            listaRespuestas.appendChild(respuestaDiv);
          });
        } catch (error) {
          console.error("âŒ Error cargando respuestas:", error);
          const listaRespuestas = document.getElementById("lista-respuestas");
          if (listaRespuestas) {
            listaRespuestas.innerHTML =
              '<p class="text-red-500 text-sm">Error cargando respuestas.</p>';
          }
        }
      }

      function cerrarModal() {
        const modal = document.getElementById("ticket-modal");
        const respuestaTexto = document.getElementById("respuesta-texto");

        if (modal) modal.classList.add("hidden");
        if (respuestaTexto) respuestaTexto.value = "";

        currentTicketId = null;
      }

      async function responderTicket() {
        if (!currentTicketId) return;

        const respuestaInput = document.getElementById("respuesta-texto");
        const nuevoEstadoSelect = document.getElementById("nuevo-estado");

        if (!respuestaInput || !nuevoEstadoSelect) return;

        const respuesta = respuestaInput.value.trim();
        const nuevoEstado = nuevoEstadoSelect.value;

        if (!respuesta) {
          alert("âŒ La respuesta es requerida");
          return;
        }

        try {
          await apiClient.respondTicket(
            currentTicketId,
            respuesta,
            nuevoEstado
          );
          alert("âœ… Respuesta enviada exitosamente");

          // Recargar respuestas y tickets
          await cargarRespuestasTicket(currentTicketId);
          await cargarTickets();

          // Limpiar formulario
          respuestaInput.value = "";
        } catch (error) {
          alert(`âŒ Error: ${error.message}`);
        }
      }

      function mostrarMensajeForm(texto, tipo) {
        const mensaje = document.getElementById("form-mensaje");
        if (!mensaje) return;

        mensaje.textContent = texto;
        mensaje.className = "text-center text-sm mt-4";

        if (tipo === "success") mensaje.classList.add("text-green-600");
        else if (tipo === "error") mensaje.classList.add("text-red-600");
        else if (tipo === "info") mensaje.classList.add("text-blue-600");

        if (tipo === "success") {
          setTimeout(() => (mensaje.textContent = ""), 3000);
        }
      }

      function cerrarSesion() {
        apiClient.logout();
      }

      // ==================
      // âœ… FUNCIONES AUXILIARES PARA NOMBRES
      // ==================

      function getTemaNombre(valor) {
        const temas = {
          materia: "ğŸ“š Materias y Horarios",
          practicas: "ğŸ”¬ PrÃ¡cticas Profesionales",
          certificados: "ğŸ“„ Certificados y Documentos",
          matricula: "ğŸ“ MatrÃ­cula y Pagos",
          notas: "ğŸ“Š Notas y Calificaciones",
          tramites: "ğŸ“‹ TrÃ¡mites Administrativos",
          becas: "ğŸ’° Becas y Ayudas",
          otro: "â“ Otro",
        };
        return temas[valor] || valor;
      }

      function getEstadoNombre(estado) {
        const estados = {
          abierto: "ğŸŸ¢ Abierto",
          en_proceso: "ğŸŸ¡ En Proceso",
          cerrado: "ğŸ”´ Cerrado",
        };
        return estados[estado] || estado;
      }

      function getPrioridadNombre(prioridad) {
        const prioridades = {
          alta: "ğŸ”´ Alta",
          media: "ğŸŸ¡ Media",
          baja: "ğŸŸ¢ Baja",
        };
        return prioridades[prioridad] || prioridad;
      }

      // Cerrar modal con Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") cerrarModal();
      });

      console.log(
        "ğŸš€ Sistema de tickets con filtrado avanzado cargado exitosamente"
      );
      console.log("ğŸ” Filtros disponibles: Estado, Tema/CategorÃ­a, Prioridad");
      console.log("ğŸ“Š EstadÃ­sticas y exportaciÃ³n: âœ…");
    </script>
  </body>
</html>
